<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ProStream: OvenPlayer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- OvenPlayer CDN -->
    <script src="https://cdn.jsdelivr.net/npm/ovenplayer/dist/ovenplayer.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { background-color: #0f0f0f; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1a1a1a; }
        ::-webkit-scrollbar-thumb { background: #4f46e5; border-radius: 4px; }
        
        .player-wrapper {
            aspect-ratio: 16/9;
            width: 100%;
            max-height: 85vh;
            background: #000;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            border: 1px solid #333;
        }
    </style>
</head>
<body class="text-gray-200 h-screen flex flex-col overflow-hidden">

    <!-- Cert Warning Banner (Hidden by default) -->
    <div id="certWarning" class="hidden bg-red-900/50 border-b border-red-500/50 text-red-200 px-4 py-3 text-sm text-center font-bold relative z-50">
        <div class="flex items-center justify-center gap-2">
            <i class="fa-solid fa-lock"></i>
            <span>SSL Connection Failed. Since you are using a self-signed cert, you MUST accept it manually.</span>
        </div>
        <div class="mt-2">
            <a id="certLink" href="#" target="_blank" class="bg-red-600 hover:bg-red-500 text-white px-3 py-1 rounded text-xs transition-colors">
                1. Click here to open Secure Port
            </a>
            <span class="mx-2 text-xs font-normal opacity-70">-> Click "Advanced" -> "Proceed to..." -> Close tab</span>
            <button onclick="location.reload()" class="bg-gray-700 hover:bg-gray-600 text-white px-3 py-1 rounded text-xs transition-colors ml-2">
                2. Refresh this page
            </button>
        </div>
    </div>

    <!-- Header -->
    <header class="bg-[#161616] border-b border-[#262626] p-4 z-20">
        <div class="container mx-auto flex justify-between items-center">
            <div class="flex items-center space-x-3">
                <div class="w-10 h-10 bg-gradient-to-br from-indigo-600 to-violet-600 rounded-lg flex items-center justify-center shadow-lg shadow-indigo-900/30">
                    <i class="fa-solid fa-fire-burner text-white text-lg"></i>
                </div>
                <div>
                    <h1 class="text-xl font-bold text-white leading-none tracking-tight">
                        ProStream <span class="text-indigo-400">OME</span>
                    </h1>
                    <p class="text-[10px] text-gray-500 font-mono uppercase tracking-widest">Sub-Second Latency</p>
                </div>
            </div>

            <div class="flex items-center gap-4">
                <div id="statusIndicator" class="flex items-center space-x-2 px-3 py-1 bg-red-900/20 text-red-500 rounded-full text-xs font-bold border border-red-900/30 uppercase tracking-wider">
                    <div class="w-2 h-2 bg-red-500 rounded-full animate-pulse"></div>
                    <span>Disconnected</span>
                </div>
                <button onclick="openSettings()" class="text-gray-400 hover:text-white transition-colors">
                    <i class="fa-solid fa-gear text-xl"></i>
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-1 container mx-auto p-4 flex flex-col items-center justify-center relative">
        <div id="playerContainer" class="player-wrapper relative group">
            <div id="player"></div>
            <div id="placeholder" class="absolute inset-0 flex flex-col items-center justify-center bg-[#0a0a0a] z-10">
                <div class="w-24 h-24 rounded-full bg-[#161616] border border-[#262626] flex items-center justify-center mb-6 shadow-2xl">
                    <i class="fa-solid fa-tv text-4xl text-gray-600"></i>
                </div>
                <h2 class="text-2xl font-bold text-gray-500 mb-2">Ready to Connect</h2>
                <p class="text-gray-600 text-sm">Waiting for stream configuration...</p>
            </div>
        </div>
    </main>

    <!-- Configuration Modal -->
    <div id="configModal" class="fixed inset-0 bg-black/90 backdrop-blur-sm z-50 flex items-center justify-center">
        <div class="bg-[#161616] border border-[#333] rounded-2xl shadow-2xl w-full max-w-md p-8">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-white">Connection Settings</h3>
                <button onclick="closeSettings()" class="text-gray-500 hover:text-white"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="space-y-5">
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-2">Server Host (IP or Domain)</label>
                    <input type="text" id="hostInput" placeholder="e.g., YOUR_PUBLIC_IP" class="w-full bg-[#0a0a0a] border border-[#333] text-white p-3 rounded-lg focus:border-indigo-500 focus:outline-none font-mono text-sm">
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-2">App Name</label>
                    <input type="text" id="appInput" value="app" class="w-full bg-[#0a0a0a] border border-[#333] text-white p-3 rounded-lg focus:border-indigo-500 focus:outline-none font-mono text-sm">
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-2">Stream Key</label>
                    <input type="text" id="streamInput" value="stream" class="w-full bg-[#0a0a0a] border border-[#333] text-white p-3 rounded-lg focus:border-indigo-500 focus:outline-none font-mono text-sm">
                </div>
                <div class="pt-4">
                    <button onclick="initializePlayer()" class="w-full py-3 px-4 bg-indigo-600 hover:bg-indigo-500 text-white font-bold rounded-lg shadow-lg transition-all flex items-center justify-center gap-2">
                        <i class="fa-solid fa-play"></i> Connect
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const configModal = document.getElementById('configModal');
        const hostInput = document.getElementById('hostInput');
        const appInput = document.getElementById('appInput');
        const streamInput = document.getElementById('streamInput');
        const placeholder = document.getElementById('placeholder');
        const statusIndicator = document.getElementById('statusIndicator');
        const certWarning = document.getElementById('certWarning');
        const certLink = document.getElementById('certLink');
        
        let player = null;
        let retryCount = 0;
        let maxRetries = 5;
        let retryTimeout = null;

        window.addEventListener('DOMContentLoaded', () => {
            const params = new URLSearchParams(window.location.search);
            const host = params.get('host');
            if (host) {
                hostInput.value = host;
                if(params.get('app')) appInput.value = params.get('app');
                if(params.get('stream')) streamInput.value = params.get('stream');
                configModal.classList.add('hidden');
                initializePlayer();
            } else {
                // Default to your public IP for easy testing
                hostInput.value = localStorage.getItem('ome_host') || window.location.hostname || 'YOUR_PUBLIC_IP';
            }
        });

        function openSettings() { configModal.classList.remove('hidden'); }
        function closeSettings() { configModal.classList.add('hidden'); }

        function initializePlayer() {
            const host = hostInput.value.trim();
            const app = appInput.value.trim();
            const stream = streamInput.value.trim();

            if (!host) { alert("Please enter a Host IP."); return; }
            localStorage.setItem('ome_host', host);
            
            const newUrl = `${window.location.pathname}?host=${host}&app=${app}&stream=${stream}`;
            window.history.pushState({path:newUrl},'',newUrl);

            closeSettings();
            placeholder.classList.add('hidden');
            
            // Reset retry counter when user manually connects
            retryCount = 0;
            clearTimeout(retryTimeout);
            
            connectToStream(host, app, stream);
        }

        function connectToStream(host, app, stream) {
            // Detect if page is served via HTTPS (like GitHub Pages)
            const isSecure = window.location.protocol === 'https:';
            const protocol = isSecure ? 'wss://' : 'ws://';
            const port = isSecure ? '3334' : '3333';

            const url = `${protocol}${host}:${port}/${app}/${stream}`;
            console.log(`Connection attempt ${retryCount + 1}/${maxRetries + 1}:`, url);
            
            updateStatus('Connecting...', 'yellow');

            // Show cert warning if using HTTPS/WSS
            if (isSecure) {
                certWarning.classList.remove('hidden');
                certLink.href = `https://${host}:${port}`;
            } else {
                certWarning.classList.add('hidden');
            }

            if (player) {
                player.remove();
                player = null;
            }

            player = OvenPlayer.create('player', {
                sources: [{ label: 'WebRTC', type: 'webrtc', file: url }],
                autoStart: true,
                mute: true,
                expandFullScreenUI: true,
                webrtcConfig: {
                    timeoutMaxRetry: 4,
                    connectionTimeout: 10000
                }
            });

            player.on('ready', () => updateStatus('Ready', 'yellow'));
            
            player.on('stateChanged', (data) => {
                if (data.newstate === 'playing') {
                    updateStatus('Live', 'green');
                    retryCount = 0; // Reset on successful connection
                } else if (data.newstate === 'idle') {
                    updateStatus('Idle', 'yellow');
                } else if (data.newstate === 'error') {
                    handleConnectionError(host, app, stream);
                }
            });

            player.on('error', (error) => {
                console.error("OvenPlayer Error:", error);
                handleConnectionError(host, app, stream);
            });
        }

        function handleConnectionError(host, app, stream) {
            if (retryCount < maxRetries) {
                retryCount++;
                const retryDelay = 3000; // 3 seconds
                updateStatus(`Retry ${retryCount}/${maxRetries}...`, 'yellow');
                console.log(`Retrying in ${retryDelay}ms...`);
                
                retryTimeout = setTimeout(() => {
                    connectToStream(host, app, stream);
                }, retryDelay);
            } else {
                updateStatus('Connection Failed', 'red');
                console.error('Max retries reached. Please check your connection and try again.');
                // Reset retry counter after final failure so user can manually retry
                setTimeout(() => { retryCount = 0; }, 5000);
            }
        }

        function updateStatus(text, color) {
            const colors = {
                'red': 'bg-red-900/20 text-red-500 border-red-900/30',
                'green': 'bg-green-900/20 text-green-500 border-green-900/30',
                'yellow': 'bg-yellow-900/20 text-yellow-500 border-yellow-900/30'
            };
            const dotColors = { 'red': 'bg-red-500', 'green': 'bg-green-500', 'yellow': 'bg-yellow-500' };
            statusIndicator.className = `flex items-center space-x-2 px-3 py-1 rounded-full text-xs font-bold border uppercase tracking-wider ${colors[color]}`;
            statusIndicator.innerHTML = `<div class="w-2 h-2 rounded-full ${dotColors[color]} ${color === 'green' ? 'animate-pulse' : ''}"></div><span>${text}</span>`;
        }
    </script>
</body>
</html>